function json(statusCode, body) {
  return {
    statusCode,
    headers: { "Content-Type": "application/json; charset=utf-8" },
    body: JSON.stringify(body),
  };
}

function requireUser(context) {
  const user = context && context.clientContext && context.clientContext.user;
  if (!user) return null;
  return user;
}

function parseBody(event) {
  if (!event || !event.body) return {};
  try {
    return JSON.parse(event.body);
  } catch (_) {
    return {};
  }
}

function toMoney(v, fallback = 0) {
  const n = Number(v);
  if (!Number.isFinite(n) || n < 0) return Number(fallback.toFixed(2));
  return Number(n.toFixed(2));
}

function slugify(value) {
  return String(value || "item")
    .toLowerCase()
    .replace(/[^a-z0-9]+/g, "-")
    .replace(/(^-|-$)/g, "")
    .slice(0, 70) || "item";
}

function uid(prefix) {
  return `${prefix}_${Math.random().toString(36).slice(2, 10)}${Date.now().toString(36).slice(-4)}`;
}

function extractJsonArray(text) {
  if (!text) return null;
  const trimmed = String(text).trim();
  try {
    const parsed = JSON.parse(trimmed);
    return Array.isArray(parsed) ? parsed : null;
  } catch (_) {
    const start = trimmed.indexOf("[");
    const end = trimmed.lastIndexOf("]");
    if (start >= 0 && end > start) {
      try {
        const parsed = JSON.parse(trimmed.slice(start, end + 1));
        return Array.isArray(parsed) ? parsed : null;
      } catch (_) {
        return null;
      }
    }
    return null;
  }
}

function normalizeOpportunity(raw) {
  const brand = String(raw.brand || "").trim();
  const itemType = String(raw.item_type || raw.itemType || "Clothing item").trim();
  const categoryRaw = String(raw.category || "clothes").toLowerCase();
  const category = categoryRaw.includes("shoe") ? "shoes" : "clothes";
  const maxBuy = toMoney(raw.max_buy_price, 18);
  const suggested = toMoney(raw.suggested_price, Math.max(maxBuy + 20, 39));
  const marginValue = suggested > 0 ? ((suggested - maxBuy) / suggested) * 100 : 0;

  const title = String(raw.title || `${brand ? `${brand} ` : ""}${itemType}`).trim() || `${brand ? `${brand} ` : ""}${itemType}`;
  const keywords = Array.isArray(raw.search_keywords) ? raw.search_keywords : String(raw.search_keywords || "").split(",");
  const checklist = Array.isArray(raw.checklist) ? raw.checklist : String(raw.checklist || "").split(/[\n,]+/);

  return {
    opp_id: uid("opp"),
    created_at: new Date().toISOString(),
    title,
    category,
    brand,
    item_type: itemType,
    search_keywords: keywords.map((k) => String(k).trim()).filter(Boolean).slice(0, 8),
    max_buy_price: maxBuy,
    suggested_price: suggested,
    margin_estimate: `${Math.max(5, marginValue).toFixed(0)}%`,
    checklist: checklist.map((c) => String(c).trim()).filter(Boolean).slice(0, 6),
    source_notes: String(raw.source_notes || "Local listing template generated by AI for Twin Falls sourcing.").trim(),
  };
}

function fallbackOpportunities(count) {
  const templates = [
    {
      title: "Nike Air Force 1 Low - White",
      category: "shoes",
      brand: "Nike",
      item_type: "Air Force 1 sneakers",
      search_keywords: ["nike af1", "air force 1 men 10", "twin falls sneakers"],
      max_buy_price: 30,
      suggested_price: 74,
      checklist: ["Check heel drag", "Inspect midsole yellowing", "Verify authentic size tag"],
    },
    {
      title: "Levi's 501 Vintage Denim",
      category: "clothes",
      brand: "Levi's",
      item_type: "501 jeans",
      search_keywords: ["levis 501 vintage", "straight leg denim", "twin falls thrift jeans"],
      max_buy_price: 18,
      suggested_price: 52,
      checklist: ["Measure inseam", "Check crotch wear", "Confirm button fly intact"],
    },
    {
      title: "Doc Martens 1460 Boots",
      category: "shoes",
      brand: "Dr. Martens",
      item_type: "1460 boots",
      search_keywords: ["doc martens 1460", "leather boots black", "women 8 boots"],
      max_buy_price: 45,
      suggested_price: 110,
      checklist: ["Inspect sole separation", "Check eyelets", "Condition leather before listing"],
    },
    {
      title: "Patagonia Better Sweater Quarter-Zip",
      category: "clothes",
      brand: "Patagonia",
      item_type: "quarter-zip fleece",
      search_keywords: ["patagonia better sweater", "mens fleece quarter zip", "outdoor fleece"],
      max_buy_price: 24,
      suggested_price: 69,
      checklist: ["Check zipper track", "Look for pilling", "Verify no sleeve stains"],
    },
  ];

  const out = [];
  for (let i = 0; i < count; i += 1) out.push(normalizeOpportunity(templates[i % templates.length]));
  return out;
}

async function generateOpportunities(count) {
  const needed = Math.max(0, Number(count) || 0);
  if (!needed) return [];

  const apiKey = process.env.OPENAI_API_KEY;
  if (!apiKey) return fallbackOpportunities(needed);

  const prompt = [
    `Generate ${needed} resale opportunities for Twin Falls, Idaho, CLOTHES + SHOES only.`,
    "Return STRICT JSON only: an array of objects.",
    "Each object keys: title, category (clothes|shoes), brand, item_type, search_keywords (array), max_buy_price (number), suggested_price (number), margin_estimate (string), checklist (array), source_notes.",
    "No markdown. No commentary. Do not include anything other than the JSON array.",
  ].join(" ");

  const model = process.env.OPENAI_MODEL || "gpt-4.1-mini";

  const res = await fetch("https://api.openai.com/v1/responses", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      Authorization: `Bearer ${apiKey}`,
    },
    body: JSON.stringify({
      model,
      input: prompt,
      max_output_tokens: 1200,
    }),
  });

  if (!res.ok) return fallbackOpportunities(needed);
  const data = await res.json().catch(() => ({}));
  const parsed = extractJsonArray(data.output_text || "");
  if (!Array.isArray(parsed) || !parsed.length) return fallbackOpportunities(needed);

  return parsed.slice(0, needed).map(normalizeOpportunity);
}

async function ensureQueue(state, minCount) {
  const queue = Array.isArray(state.ai_queue) ? state.ai_queue : [];
  if (queue.length >= minCount) {
    state.ai_queue = queue;
    return state;
  }

  const needed = minCount - queue.length;
  const created = await generateOpportunities(needed);
  state.ai_queue = queue.concat(created);
  return state;
}

function makeDraftFromOpportunity(opportunity, existingDrafts) {
  const title = `${opportunity.brand ? `${opportunity.brand} ` : ""}${opportunity.item_type}`.trim() || opportunity.title;
  const base = slugify(title);
  const existingIds = new Set((existingDrafts || []).map((d) => String(d.id || "")));
  let id = base;
  let i = 2;
  while (existingIds.has(id)) {
    id = `${base}-${i}`;
    i += 1;
  }

  const price = toMoney(opportunity.suggested_price, 39);
  const buyMax = toMoney(opportunity.max_buy_price, 18);

  return {
    id,
    created_at: new Date().toISOString(),
    status: "draft",
    title,
    price,
    photos: [],
    description: `AI draft listing for ${title}. Suggested sourcing keywords: ${(opportunity.search_keywords || []).join(", ")}. Condition checklist: ${(opportunity.checklist || []).join("; ")}.`,
    tags: ["ai-draft"],
    buy_price_max: buyMax,
    source_notes: String(opportunity.source_notes || "AI sourcing opportunity accepted."),
    search_keywords: Array.isArray(opportunity.search_keywords) ? opportunity.search_keywords : [],
    opportunity_id: opportunity.opp_id,
    margin_estimate: opportunity.margin_estimate || "",
    inventory: 1,
  };
}

module.exports = {
  json,
  parseBody,
  requireUser,
  ensureQueue,
  makeDraftFromOpportunity,
};
