<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Sawtooth Thrift Admin Dashboard</title>
    <style>
      :root { color-scheme: dark; }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        background: #0b1220;
        color: #e2e8f0;
      }
      .wrap { max-width: 1200px; margin: 0 auto; padding: 16px; }
      .topbar {
        display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:14px;
        border:1px solid rgba(255,255,255,.12); border-radius:12px; background:#111827; padding:12px;
      }
      .tabs { display:flex; gap:8px; flex-wrap:wrap; }
      .tab-btn, .btn, input, select, textarea {
        border-radius:10px; border:1px solid rgba(255,255,255,.18); background:#1f2937; color:#fff;
        font: inherit;
      }
      .tab-btn, .btn { padding:8px 12px; cursor:pointer; font-weight:700; }
      .tab-btn.active { background:#2563eb; border-color:#3b82f6; }
      .btn.ghost { background:transparent; }
      .panel { display:none; border:1px solid rgba(255,255,255,.12); border-radius:12px; background:#111827; padding:12px; }
      .panel.active { display:block; }
      .muted { color:#94a3b8; font-size:.92rem; }
      .status { margin:10px 0; min-height: 1.2rem; color:#93c5fd; }
      .grid { display:grid; gap:10px; }
      .opp, .card { border:1px solid rgba(255,255,255,.15); border-radius:12px; padding:10px; background:#0f172a; }
      .opp h4, .card h4 { margin:0 0 6px; }
      .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
      .pill { display:inline-block; border:1px solid rgba(255,255,255,.2); border-radius:999px; padding:2px 8px; font-size:.8rem; }
      .danger { color:#fecaca; }
      .warning { color:#fbbf24; }
      .hidden { display:none !important; }
      .split { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
      .products-grid { display:grid; gap:10px; }
      .photo-preview-grid { display:grid; gap:8px; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); }
      .photo-preview-grid img { width:100%; aspect-ratio:1/1; object-fit:cover; border-radius:8px; border:1px solid rgba(255,255,255,.2); }
      .photo-preview-item { position:relative; }
      .photo-preview-item .remove-photo-btn { position:absolute; top:4px; right:4px; border:0; border-radius:999px; padding:2px 7px; background:rgba(15,23,42,.9); color:#fff; cursor:pointer; }
      .product-summary { list-style:none; display:flex; justify-content:space-between; align-items:center; gap:10px; cursor:pointer; }
      .product-summary::-webkit-details-marker { display:none; }
      .product-headline { display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
      .field { display:grid; gap:6px; }
      input, select, textarea { padding:8px 10px; width:100%; }
      textarea { min-height:84px; }
      details summary { cursor:pointer; }
      pre { white-space:pre-wrap; margin:6px 0; }
      @media (max-width: 900px){ .split { grid-template-columns:1fr; } }
    </style>
  </head>
  <body>
    <main class="wrap">
      <header class="topbar">
        <div>
          <strong>Sawtooth Thrift Admin</strong>
          <div class="muted">DB-only dashboard (legacy CMS removed).</div>
        </div>
        <div class="row">
          <a class="btn ghost" href="/" id="backToStoreBtn">Back to storefront</a>
          <button class="btn ghost" id="refreshAllBtn" type="button">Refresh active tab</button>
          <button class="btn ghost" id="logoutBtn" type="button">Logout</button>
        </div>
      </header>

      <nav class="tabs" aria-label="Admin sections">
        <button class="tab-btn active" data-tab="ai" type="button">AI Sourcing</button>
        <button class="tab-btn" data-tab="products" type="button">DB Products</button>
        <button class="tab-btn" data-tab="orders" type="button">Orders</button>
        <button class="tab-btn" data-tab="revenue" type="button">Revenue</button>
      </nav>

      <section class="status" id="globalStatus" aria-live="polite"></section>

      <section class="card hidden" id="dbSetupCard" style="margin-bottom:12px;">
        <h3 style="margin-top:0">Database Setup</h3>
        <p class="warning" id="dbSetupMessage">Database not initialized.</p>
        <div class="row">
          <button class="btn" id="dbInitBtn" type="button">Initialize Database</button>
        </div>
      </section>

      <section class="panel active" id="tab-ai">
        <h2 style="margin-top:0">AI Sourcing (Clothes & Shoes)</h2>
        <p class="muted">Always displays exactly 3 opportunities. Accept creates draft product with default inventory=1. Decline refreshes queue immediately.</p>
        <div class="row" style="margin-bottom:8px;">
          <button class="btn" id="aiRefreshBtn" type="button">Refresh opportunities</button>
        </div>
        <div class="split">
          <div>
            <h3>Opportunities</h3>
            <div class="grid" id="aiOpportunities"></div>
          </div>
          <div>
            <h3>AI Draft Products</h3>
            <div class="grid" id="aiDrafts"></div>
          </div>
        </div>
      </section>

      <section class="panel" id="tab-products">
        <h2 style="margin-top:0">DB Products</h2>
        <p class="muted">Edit title, price, description, inventory, and status. Setting status=active publishes instantly.</p>
        <p class="muted warning">Archiving removes stored photos to save space.</p>
        <div class="row" style="margin-bottom:8px;">
          <button class="btn" id="productsRefreshBtn" type="button">Refresh products</button>
          <button class="btn" id="newProductBtn" type="button">New Product</button>
        </div>
        <div class="split" style="margin-bottom:8px;">
          <div class="field"><label>Search products</label><input id="productsSearch" placeholder="Search by title, id, description" /></div>
          <div class="row">
            <label class="field" style="min-width:170px;"><span>Status</span><select id="productsStatusFilter"><option value="all">All</option><option value="active">Active</option><option value="draft">Draft</option><option value="archived">Archived</option></select></label>
            <label><input id="productsInStockOnly" type="checkbox" /> In stock only</label>
            <label><input id="productsShowArchived" type="checkbox" /> Show archived</label>
          </div>
        </div>
        <section class="card hidden" id="newProductForm" style="margin-bottom:12px;">
          <h3 style="margin-top:0">Create Product</h3>
          <div class="field"><label>Title *</label><input id="newTitle" /></div>
          <div class="split">
            <div class="field"><label>Price (USD) *</label><input id="newPrice" type="number" min="0" step="0.01" /></div>
            <div class="field"><label>Inventory</label><input id="newInventory" type="number" min="0" step="1" value="1" /></div>
          </div>
          <div class="field"><label>Status</label><select id="newStatus"><option value="draft" selected>draft</option><option value="active">active</option></select></div>
          <div class="field"><label>Description</label><textarea id="newDescription"></textarea></div>
          <div class="field"><label>Photos (optional)</label><div class="row"><button class="btn ghost" id="newAddPhotosBtn" type="button">Add photos</button><input id="newPhotoInput" type="file" accept="image/*" capture="environment" multiple class="hidden" /></div><div class="muted">On supported phones, Add photos opens camera or photo library.</div><div id="newPhotoPreviews" class="photo-preview-grid"></div></div>
          <div class="row">
            <button class="btn" id="createProductBtn" type="button">Create Product</button>
            <button class="btn ghost" id="cancelProductBtn" type="button">Cancel</button>
          </div>
        </section>
        <div class="products-grid" id="productsList"></div>
      </section>

      <section class="panel" id="tab-orders">
        <h2 style="margin-top:0">Orders</h2>
        <p class="muted">Paid Stripe checkouts for fulfillment. Print packing slip and optionally mark shipped.</p>
        <div class="row" style="margin-bottom:8px;">
          <select id="orderStatus">
            <option value="unshipped">Unshipped</option>
            <option value="shipped">Shipped</option>
            <option value="all">All</option>
          </select>
          <input id="orderSearch" type="search" placeholder="Search order id or email" />
          <button class="btn" id="ordersRefreshBtn" type="button">Refresh orders</button>
        </div>
        <div class="grid" id="ordersList"></div>
      </section>

      <section class="panel" id="tab-revenue">
        <h2 style="margin-top:0">Revenue</h2>
        <p class="muted">Stripe paid checkout stats for the last 7 and 30 days.</p>
        <div class="row" style="margin-bottom:8px;">
          <button class="btn" id="revenueRefreshBtn" type="button">Refresh revenue</button>
        </div>
        <div class="split" id="revenueStats">
          <article class="card">
            <h3 style="margin-top:0">Last 7 days</h3>
            <div class="muted" data-rev-7d>Loading…</div>
          </article>
          <article class="card">
            <h3 style="margin-top:0">Last 30 days</h3>
            <div class="muted" data-rev-30d>Loading…</div>
          </article>
        </div>
      </section>
    </main>

    <script>
      (function(){
        const $ = (sel) => document.querySelector(sel);
        const $$ = (sel) => Array.from(document.querySelectorAll(sel));
        const state = { activeTab: 'ai', products: [], drafts: [], dbTables: null, newPhotoFiles: [], newPhotoPreviewUrls: [], photoDrafts: {} };
        const REQUIRED_TABLES = ['products', 'product_images', 'ai_opportunities', 'processed_stripe_sessions'];

        function esc(s){ return String(s||'').replace(/[&<>"']/g, (c)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }
        function money(n){ const v=Number(n||0); return Number.isFinite(v) ? `$${v.toFixed(2)}` : '$0.00'; }
        function setStatus(msg, isErr){ const el=$('#globalStatus'); el.textContent=msg||''; el.style.color=isErr?'#fca5a5':'#93c5fd'; }

        function friendlyError(msg){
          const text = String(msg || 'Request failed').trim();
          if (/relation .* does not exist/i.test(text) || /42P01/.test(text)) return 'DB tables missing. Go to Settings -> Initialize Database.';
          if (/products|ai_opportunities|processed_stripe_sessions/i.test(text) && /does not exist/i.test(text)) return 'DB tables missing. Go to Settings -> Initialize Database.';
          return text;
        }

        function fallbackFunctionUrl(url){
          if (!url || !String(url).startsWith('/.netlify/functions/')) return '';
          return String(url).replace('/.netlify/functions/', '/api/');
        }

        async function requestJson(url, opts){
          const res = await fetch(url, {
            credentials: 'include',
            headers: { 'Content-Type':'application/json', ...((opts&&opts.headers)||{}) },
            ...(opts||{})
          });
          const data = await res.json().catch(()=>({}));
          return { res, data };
        }

        async function api(url, opts){
          let { res, data } = await requestJson(url, opts);
          if (res.status === 404) {
            const fallbackUrl = fallbackFunctionUrl(url);
            if (fallbackUrl) {
              ({ res, data } = await requestJson(fallbackUrl, opts));
            }
          }
          if (!res.ok || data.ok === false) throw new Error(friendlyError(data.error || `Request failed (${res.status})`));
          return data;
        }


        async function uploadPhotoFile(file, productId){
          const uploadOnce = async (url)=>{
            const form = new FormData();
            form.append('file', file);
            form.append('product_id', productId);
            const res = await fetch(url, { method:'POST', credentials:'include', body: form });
            const data = await res.json().catch(()=>({}));
            return { res, data };
          };

          let { res, data } = await uploadOnce('/.netlify/functions/admin-upload-photo');
          if (res.status === 404) {
            ({ res, data } = await uploadOnce('/api/admin-upload-photo'));
          }
          if (!res.ok || data.ok === false || !data.url) throw new Error(friendlyError((data && data.error) || `Photo upload failed (${res.status})`));
          return data.url;
        }

        function renderNewPhotoPreviews(){
          const wrap = $('#newPhotoPreviews');
          wrap.innerHTML = state.newPhotoPreviewUrls.map((url, idx)=>`<div class="photo-preview-item"><img src="${esc(url)}" alt="Selected photo preview" /><button class="remove-photo-btn" data-remove-new-photo="${idx}" type="button">×</button></div>`).join('');
          wrap.querySelectorAll('[data-remove-new-photo]').forEach((btn)=>btn.addEventListener('click', ()=>{
            const idx = Number(btn.getAttribute('data-remove-new-photo'));
            if (!Number.isInteger(idx) || idx < 0) return;
            removeNewPhotoAt(idx);
          }));
        }

        function removeNewPhotoAt(index){
          const removedPreview = state.newPhotoPreviewUrls[index];
          if (removedPreview) URL.revokeObjectURL(removedPreview);
          state.newPhotoFiles.splice(index, 1);
          state.newPhotoPreviewUrls.splice(index, 1);
          renderNewPhotoPreviews();
        }

        function setNewPhotoFiles(fileList){
          const incoming = Array.from(fileList || []);
          for (const file of incoming) {
            state.newPhotoFiles.push(file);
            state.newPhotoPreviewUrls.push(URL.createObjectURL(file));
          }
          renderNewPhotoPreviews();
        }

        function showDbSetup(tables){
          const missing = REQUIRED_TABLES.filter((name)=>!tables[name]);
          const card = $('#dbSetupCard');
          if (!missing.length) { card.classList.add('hidden'); return; }
          card.classList.remove('hidden');
          $('#dbSetupMessage').textContent = `Database not initialized. Missing: ${missing.join(', ')}`;
          setStatus('DB tables missing. Go to Settings -> Initialize Database.', true);
        }

        async function checkDbStatus(){
          try {
            const data = await api('/.netlify/functions/admin-db-init');
            state.dbTables = data.tables || {};
            showDbSetup(state.dbTables);
          } catch (e) {
            setStatus(e.message || 'Failed to check database status.', true);
          }
        }

        function setTab(tab){
          state.activeTab = tab;
          $$('.tab-btn').forEach((b)=>b.classList.toggle('active', b.getAttribute('data-tab')===tab));
          $$('.panel').forEach((p)=>p.classList.remove('active'));
          $('#tab-'+tab).classList.add('active');
        }

        async function loadAi(){
          setStatus('Loading AI sourcing…');
          const [oppData, draftData] = await Promise.all([
            api('/.netlify/functions/ai-opportunities'),
            api('/.netlify/functions/draft-products')
          ]);
          state.drafts = Array.isArray(draftData.drafts) ? draftData.drafts : [];
          renderOpps(oppData.opportunities || []);
          renderDrafts(state.drafts);
          setStatus('Loaded AI opportunities + drafts.');
        }

        function renderOpps(items){
          const el = $('#aiOpportunities');
          const list = Array.isArray(items) ? items : [];
          if (!list.length) { el.innerHTML = '<div class="muted">No opportunities available.</div>'; return; }

          const renderLinkList = (entries, labelKey='label') => {
            if (!Array.isArray(entries) || !entries.length) return '<div class="muted">None</div>';
            return `<ul>${entries.map((item)=>`<li><a href="${esc(item.url || '#')}" target="_blank" rel="noopener">${esc(item[labelKey] || 'Link')}</a></li>`).join('')}</ul>`;
          };

          el.innerHTML = list.map((o)=>`
            <article class="opp" data-id="${esc(o.opp_id)}">
              <h4>${esc(o.title)}</h4>
              <div class="row"><span class="pill">${esc(o.category||'clothes')}</span><span class="muted">Margin ${esc(o.margin_estimate||'')}</span></div>
              <div class="muted">Buy max: ${money(o.max_buy_price)} · Suggested: ${money(o.suggested_price)}</div>
              <div class="muted">Keywords: ${esc((o.search_keywords||[]).join(', '))}</div>
              <pre class="muted">Checklist: ${(o.checklist||[]).map(esc).join('; ')}</pre>
              <div class="muted"><strong>Where to buy</strong>${renderLinkList(o.buy_links || [], 'label')}</div>
              <div class="muted"><strong>Local pickup</strong>${renderLinkList(o.local_pickup || [], 'place')}</div>
              <div class="row">
                <button class="btn" data-action="accept" type="button">Accept</button>
                <button class="btn ghost" data-action="decline" type="button">Decline</button>
              </div>
            </article>
          `).join('');

          el.querySelectorAll('button[data-action]').forEach((btn)=>btn.addEventListener('click', async ()=>{
            const card = btn.closest('[data-id]');
            const opp_id = card ? card.getAttribute('data-id') : '';
            if (!opp_id) return;
            btn.disabled = true;
            try{
              if (btn.getAttribute('data-action')==='accept') {
                const data = await api('/.netlify/functions/ai-accept', { method:'POST', body: JSON.stringify({ opp_id }) });
                renderOpps(data.opportunities || []);
                await loadDraftsOnly();
                if (state.activeTab === 'products') await loadProducts();
                setStatus('Accepted opportunity and created draft product.');
              } else {
                const data = await api('/.netlify/functions/ai-decline', { method:'POST', body: JSON.stringify({ opp_id }) });
                renderOpps(data.opportunities || []);
                setStatus('Declined opportunity and refreshed back to 3.');
              }
            } catch (e) { setStatus(e.message||'Action failed', true); }
            finally { btn.disabled = false; }
          }));
        }

        async function loadDraftsOnly(){
          const draftData = await api('/.netlify/functions/draft-products');
          state.drafts = Array.isArray(draftData.drafts) ? draftData.drafts : [];
          renderDrafts(state.drafts);
        }

        function renderDrafts(items){
          const el = $('#aiDrafts');
          const list = Array.isArray(items) ? items : [];
          if (!list.length) { el.innerHTML = '<div class="muted">No AI draft products yet.</div>'; return; }
          el.innerHTML = list.map((d)=>{
            const inv = Number.isInteger(Number(d.inventory)) ? Number(d.inventory) : 0;
            const status = String(d.status || 'draft').toLowerCase();
            const toggleLabel = status === 'active' ? 'Unpublish' : 'Publish';
            const nextStatus = status === 'active' ? 'draft' : 'active';
            return `<article class="card" data-id="${esc(d.id)}">
              <h4>${esc(d.title)} ${inv<=0?'<span class="pill danger">Sold out</span>':''}</h4>
              <div class="muted">Status: <strong>${esc(status)}</strong> · Price: ${money(d.price)}</div>
              <div class="row">
                <label>Inventory <input type="number" min="0" step="1" value="${inv}" data-field="inventory" /></label>
                <button class="btn" data-save type="button">Save</button>
                <button class="btn ghost" data-toggle-status="${esc(nextStatus)}" type="button">${toggleLabel}</button>
              </div>
            </article>`;
          }).join('');


          el.querySelectorAll('button[data-archive-status]').forEach((btn)=>btn.addEventListener('click', async (e)=>{
            e.preventDefault();
            e.stopPropagation();
            const card = btn.closest('[data-id]');
            const id = card.getAttribute('data-id');
            const nextStatus = btn.getAttribute('data-archive-status') || 'archived';
            if (nextStatus === 'archived') {
              const confirmed = window.confirm('Archiving removes stored photos to save space. Continue?');
              if (!confirmed) return;
            }
            btn.disabled = true;
            try {
              await api('/.netlify/functions/admin-products', { method:'PATCH', body: JSON.stringify({ id, updates:{ status: nextStatus } }) });
              await loadProducts();
              setStatus(nextStatus === 'archived' ? 'Archived product.' : 'Restored product to draft.');
            } catch (e4) { setStatus(e4.message||'Archive update failed', true); }
            finally { btn.disabled = false; }
          }));

          el.querySelectorAll('button[data-save]').forEach((btn)=>btn.addEventListener('click', async ()=>{
            const card = btn.closest('[data-id]');
            const id = card ? card.getAttribute('data-id') : '';
            const inv = Number(card.querySelector('[data-field="inventory"]').value || 0);
            if (!Number.isInteger(inv) || inv < 0) { setStatus('Inventory must be an integer >= 0.', true); return; }
            btn.disabled = true;
            try {
              await api('/.netlify/functions/draft-products', { method:'PATCH', body: JSON.stringify({ id, updates:{ inventory: inv } }) });
              await loadDraftsOnly();
              if (state.activeTab === 'products') await loadProducts();
              setStatus('AI product inventory updated.');
            } catch (e) { setStatus(e.message||'Failed to update draft', true); }
            finally { btn.disabled = false; }
          }));

          el.querySelectorAll('button[data-toggle-status]').forEach((btn)=>btn.addEventListener('click', async ()=>{
            const card = btn.closest('[data-id]');
            const id = card ? card.getAttribute('data-id') : '';
            const nextStatus = btn.getAttribute('data-toggle-status') || 'draft';
            btn.disabled = true;
            try {
              await api('/.netlify/functions/admin-products', { method:'PATCH', body: JSON.stringify({ id, updates:{ status: nextStatus } }) });
              await loadDraftsOnly();
              if (state.activeTab === 'products') await loadProducts();
              setStatus(nextStatus === 'active' ? 'Published.' : 'Unpublished to draft.');
            } catch (e) { setStatus(e.message||'Failed to update status', true); }
            finally { btn.disabled = false; }
          }));
        }

        async function loadProducts(){
          setStatus('Loading products…');
          const data = await api('/.netlify/functions/admin-products');
          state.products = Array.isArray(data.products) ? data.products : [];
          state.photoDrafts = Object.fromEntries(state.products.map((p)=>[String(p.id), Array.isArray(p.photos) ? [...p.photos] : []]));
          renderProducts(state.products);
          setStatus('Loaded products.');
        }

        function resetNewProductForm(){
          $('#newTitle').value = '';
          $('#newPrice').value = '';
          $('#newInventory').value = '1';
          $('#newStatus').value = 'draft';
          $('#newDescription').value = '';
          $('#newPhotoInput').value = '';
          state.newPhotoPreviewUrls.forEach((u)=>URL.revokeObjectURL(u));
          state.newPhotoFiles = [];
          state.newPhotoPreviewUrls = [];
          renderNewPhotoPreviews();
        }

        function filteredProducts(items){
          const q = String($('#productsSearch').value || '').trim().toLowerCase();
          const statusFilter = String($('#productsStatusFilter').value || 'all').toLowerCase();
          const inStockOnly = $('#productsInStockOnly').checked;
          const showArchived = $('#productsShowArchived').checked;
          return (Array.isArray(items) ? items : []).filter((p)=>{
            const hay = `${p.id || ''} ${p.title || ''} ${p.description || ''}`.toLowerCase();
            if (q && !hay.includes(q)) return false;
            if (!showArchived && String(p.status || '').toLowerCase() === 'archived') return false;
            if (statusFilter !== 'all' && String(p.status || '').toLowerCase() !== statusFilter) return false;
            if (inStockOnly && Number(p.inventory || 0) <= 0) return false;
            return true;
          });
        }


        function renderProductPhotoManager(card, productId, status){
          const wrap = card.querySelector('[data-photo-manager]');
          if (!wrap) return;
          const photos = Array.isArray(state.photoDrafts[productId]) ? state.photoDrafts[productId] : [];
          if (status === 'archived') {
            wrap.innerHTML = '<div class="muted">Photo upload is disabled for archived products.</div>';
            return;
          }

          wrap.innerHTML = `
            <div class="row" style="margin-bottom:6px;">
              <button class="btn ghost" data-add-photos type="button">Add photos</button>
              <input data-photo-input type="file" accept="image/*" capture="environment" multiple class="hidden" />
            </div>
            <div class="photo-preview-grid">
              ${photos.map((url, index)=>`<div class="photo-preview-item"><img src="${esc(url)}" alt="Product photo" /><button class="remove-photo-btn" data-remove-photo="${index}" type="button">×</button></div>`).join('')}
            </div>
          `;

          const addBtn = wrap.querySelector('[data-add-photos]');
          const input = wrap.querySelector('[data-photo-input]');
          if (addBtn && input) {
            addBtn.addEventListener('click', (e)=>{ e.preventDefault(); e.stopPropagation(); input.click(); });
            input.addEventListener('click', (e)=>{ e.stopPropagation(); });
            input.addEventListener('change', async (e)=>{
              const files = Array.from(e.target.files || []);
              if (!files.length) return;
              addBtn.disabled = true;
              try {
                for (const file of files) {
                  const uploadedUrl = await uploadPhotoFile(file, productId);
                  photos.push(uploadedUrl);
                }
                state.photoDrafts[productId] = photos;
                renderProductPhotoManager(card, productId, status);
                setStatus('Photo upload complete.');
              } catch (err) {
                setStatus(err.message || 'Photo upload failed.', true);
              } finally {
                addBtn.disabled = false;
                input.value = '';
              }
            });
          }

          wrap.querySelectorAll('[data-remove-photo]').forEach((btn)=>btn.addEventListener('click', (e)=>{
            e.preventDefault();
            e.stopPropagation();
            const idx = Number(btn.getAttribute('data-remove-photo'));
            if (!Number.isInteger(idx) || idx < 0) return;
            photos.splice(idx, 1);
            state.photoDrafts[productId] = photos;
            renderProductPhotoManager(card, productId, status);
          }));
        }

        function renderProducts(items){
          const el = $('#productsList');
          const list = filteredProducts(items);
          if (!list.length){ el.innerHTML = '<div class="muted">No products found.</div>'; return; }
          el.innerHTML = list.map((p)=>{
            const inv = Number.isInteger(Number(p.inventory)) ? Number(p.inventory) : 0;
            const status = String(p.status || 'draft').toLowerCase();
            const quickStatus = status === 'active' ? 'draft' : 'active';
            const quickLabel = status === 'active' ? 'Unpublish' : 'Publish';
            const archiveLabel = status === 'archived' ? 'Restore' : 'Archive';
            const archiveStatus = status === 'archived' ? 'draft' : 'archived';
            return `<details class="card" data-id="${esc(p.id)}">
              <summary class="product-summary">
                <div class="product-headline">
                  <strong>${esc(p.title || p.id)}</strong>
                  <span class="muted">(${esc(p.id)})</span>
                  <span class="pill">${esc(status)}</span>
                  ${inv<=0?'<span class="pill danger">Sold out</span>':''}
                </div>
                <div class="row">
                  <span>${money(p.price)} · Inv ${inv}</span>
                  <button class="btn ghost" data-quick-status="${esc(quickStatus)}" type="button">${quickLabel}</button>
                  <button class="btn ghost" data-archive-status="${esc(archiveStatus)}" type="button">${archiveLabel}</button>
                </div>
              </summary>
              <div class="field"><label>Title</label><input data-field="title" value="${esc(p.title)}" /></div>
              <div class="split">
                <div class="field"><label>Price</label><input data-field="price" type="number" step="0.01" min="0" value="${Number(p.price||0).toFixed(2)}" /></div>
                <div class="field"><label>Inventory</label><input data-field="inventory" type="number" step="1" min="0" value="${inv}" /></div>
              </div>
              <div class="field"><label>Status</label><select data-field="status"><option value="draft" ${p.status==='draft'?'selected':''}>draft</option><option value="active" ${p.status==='active'?'selected':''}>active</option><option value="archived" ${p.status==='archived'?'selected':''}>archived</option></select></div>
              <div class="field"><label>Description</label><textarea data-field="description">${esc(p.description||'')}</textarea></div>
              <div class="field"><label>Photos (optional)</label><div data-photo-manager></div></div>
              <button class="btn" data-save type="button">Save</button>
            </details>`;
          }).join('');

          el.querySelectorAll('[data-id]').forEach((card)=>{
            const id = card.getAttribute('data-id');
            const product = list.find((p)=>String(p.id) === String(id));
            renderProductPhotoManager(card, id, String(product && product.status || 'draft').toLowerCase());
          });

          el.querySelectorAll('button[data-quick-status]').forEach((btn)=>btn.addEventListener('click', async (e)=>{
            e.preventDefault();
            e.stopPropagation();
            const card = btn.closest('[data-id]');
            const id = card.getAttribute('data-id');
            const nextStatus = btn.getAttribute('data-quick-status') || 'draft';
            btn.disabled = true;
            try {
              await api('/.netlify/functions/admin-products', { method:'PATCH', body: JSON.stringify({ id, updates:{ status: nextStatus } }) });
              await loadProducts();
              setStatus(nextStatus === 'active' ? 'Published.' : 'Unpublished to draft.');
            } catch (e2) { setStatus(e2.message||'Status update failed', true); }
            finally { btn.disabled = false; }
          }));


          el.querySelectorAll('button[data-archive-status]').forEach((btn)=>btn.addEventListener('click', async (e)=>{
            e.preventDefault();
            e.stopPropagation();
            const card = btn.closest('[data-id]');
            const id = card.getAttribute('data-id');
            const nextStatus = btn.getAttribute('data-archive-status') || 'archived';
            if (nextStatus === 'archived') {
              const confirmed = window.confirm('Archiving removes stored photos to save space. Continue?');
              if (!confirmed) return;
            }
            btn.disabled = true;
            try {
              await api('/.netlify/functions/admin-products', { method:'PATCH', body: JSON.stringify({ id, updates:{ status: nextStatus } }) });
              await loadProducts();
              setStatus(nextStatus === 'archived' ? 'Archived product.' : 'Restored product to draft.');
            } catch (e4) { setStatus(e4.message||'Archive update failed', true); }
            finally { btn.disabled = false; }
          }));

          el.querySelectorAll('button[data-save]').forEach((btn)=>btn.addEventListener('click', async ()=>{
            const card = btn.closest('[data-id]');
            const id = card.getAttribute('data-id');
            const inventory = Number(card.querySelector('[data-field="inventory"]').value || 0);
            const price = Number(card.querySelector('[data-field="price"]').value || 0);
            const photos = Array.isArray(state.photoDrafts[id]) ? state.photoDrafts[id] : [];
            if (!Number.isInteger(inventory) || inventory < 0) { setStatus('Inventory must be integer >= 0.', true); return; }
            if (!Number.isFinite(price) || price < 0) { setStatus('Price must be >= 0.', true); return; }
            btn.disabled = true;
            try {
              await api('/.netlify/functions/admin-products', { method:'PATCH', body: JSON.stringify({
                id,
                updates: {
                  title: card.querySelector('[data-field="title"]').value || '',
                  description: card.querySelector('[data-field="description"]').value || '',
                  status: card.querySelector('[data-field="status"]').value || 'draft',
                  inventory,
                  price,
                  photos,
                }
              }) });
              await loadProducts();
              setStatus(`Saved ${id}.`);
            } catch (e3) { setStatus(e3.message||'Save failed', true); }
            finally { btn.disabled = false; }
          }));
        }

        function formatUsdFromCents(cents){
          return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format((Number(cents || 0) / 100));
        }

        function renderRevenue(stats){
          const seven = stats && stats.window_7d ? stats.window_7d : { grossCents: 0, orderCount: 0, avgOrderCents: 0 };
          const thirty = stats && stats.window_30d ? stats.window_30d : { grossCents: 0, orderCount: 0, avgOrderCents: 0 };

          const sevenEl = document.querySelector('[data-rev-7d]');
          const thirtyEl = document.querySelector('[data-rev-30d]');

          sevenEl.innerHTML = `Gross: <strong>${formatUsdFromCents(seven.grossCents)}</strong><br/>Orders: <strong>${Number(seven.orderCount || 0)}</strong><br/>Avg order: <strong>${formatUsdFromCents(seven.avgOrderCents)}</strong>`;
          thirtyEl.innerHTML = `Gross: <strong>${formatUsdFromCents(thirty.grossCents)}</strong><br/>Orders: <strong>${Number(thirty.orderCount || 0)}</strong><br/>Avg order: <strong>${formatUsdFromCents(thirty.avgOrderCents)}</strong>`;
        }

        async function loadRevenue(){
          setStatus('Loading revenue…');
          const data = await api('/.netlify/functions/stripe-revenue-stats');
          renderRevenue(data.stats || null);
          setStatus('Loaded revenue stats.');
        }

        async function loadOrders(){
          setStatus('Loading orders…');
          const params = new URLSearchParams({
            limit: '50',
            status: $('#orderStatus').value || 'unshipped',
            q: ($('#orderSearch').value || '').trim(),
          });
          const data = await api('/.netlify/functions/stripe-orders?' + params.toString());
          renderOrders(data.orders || []);
          setStatus(`Loaded ${Array.isArray(data.orders) ? data.orders.length : 0} orders.`);
        }

        function printPackingSlip(order){
          const rec = order.recipient || {};
          const items = (order.items || []).map((i)=>`${i.quantity || 1} x ${i.name || 'Item'}`).join('\n');
          const html = `<!doctype html><html><body style="font-family:Arial,sans-serif;padding:24px;">
            <h2>Packing Slip</h2>
            <div><b>Order:</b> ${esc(order.id || '')}</div>
            <div><b>Date:</b> ${new Date((order.created || 0)*1000).toLocaleString()}</div>
            <hr/>
            <h3>Ship To</h3>
            <div>${esc(rec.name||'')}</div><div>${esc(rec.line1||'')}</div><div>${esc(rec.line2||'')}</div>
            <div>${esc((rec.city||'') + ', ' + (rec.state||'') + ' ' + (rec.zip||''))}</div><div>${esc(rec.country||'')}</div>
            <hr/>
            <h3>Items</h3>
            <pre>${esc(items)}</pre>
            <hr/>
            <div><b>Tracking:</b> ____________________________</div>
          </body></html>`;
          const w = window.open('', '_blank');
          if (!w) return;
          w.document.write(html);
          w.document.close();
          w.focus();
          w.print();
        }

        function renderOrders(items){
          const el = $('#ordersList');
          if (!items.length){ el.innerHTML = '<div class="muted">No matching orders.</div>'; return; }
          el.innerHTML = items.map((o)=>{
            const rec = o.recipient || {};
            const status = String(o.fulfillment_status || '').toUpperCase();
            const when = o.created ? new Date(o.created * 1000).toLocaleString() : '';
            const itemsText = (o.items || []).map((it)=>`${it.quantity || 1} x ${it.name || 'Item'}`).join('\n');
            return `<details class="card" data-id="${esc(o.id)}">
              <summary><strong>${esc(o.id)}</strong> · ${esc(when)} · ${esc(o.customer_email||'')} · ${esc(status)}</summary>
              <div class="split" style="margin-top:8px;">
                <div><strong>Ship To</strong><pre>${esc([rec.name,rec.line1,rec.line2,`${rec.city||''}, ${rec.state||''} ${rec.zip||''}`,rec.country].filter(Boolean).join('\n'))}</pre></div>
                <div><strong>Items</strong><pre>${esc(itemsText)}</pre></div>
              </div>
              <div class="row">
                <input data-tracking placeholder="Tracking #" value="${esc(o.tracking||'')}" />
                <button class="btn ghost" data-print type="button">Print packing slip</button>
                <button class="btn ghost" data-copy type="button">Copy ship-to address</button>
                <button class="btn" data-ship type="button">Mark shipped</button>
              </div>
            </details>`;
          }).join('');

          el.querySelectorAll('button[data-print]').forEach((btn)=>btn.addEventListener('click', ()=>{
            const id = btn.closest('[data-id]').getAttribute('data-id');
            const order = items.find((x)=>x.id===id);
            if (order) printPackingSlip(order);
          }));

          el.querySelectorAll('button[data-copy]').forEach((btn)=>btn.addEventListener('click', async ()=>{
            const card = btn.closest('[data-id]');
            const id = card.getAttribute('data-id');
            const order = items.find((x)=>x.id===id);
            if (!order) return;
            const r = order.recipient || {};
            const text = [r.name,r.line1,r.line2,`${r.city||''}, ${r.state||''} ${r.zip||''}`,r.country].filter(Boolean).join('\n');
            try { await navigator.clipboard.writeText(text); setStatus('Copied address.'); } catch (_) { setStatus('Copy failed.', true); }
          }));

          el.querySelectorAll('button[data-ship]').forEach((btn)=>btn.addEventListener('click', async ()=>{
            const card = btn.closest('[data-id]');
            const sessionId = card.getAttribute('data-id');
            const tracking = card.querySelector('[data-tracking]').value || '';
            btn.disabled = true;
            try {
              await api('/.netlify/functions/stripe-mark-shipped', { method:'POST', body: JSON.stringify({ sessionId, tracking }) });
              await loadOrders();
              setStatus('Order marked shipped.');
            } catch (e) { setStatus(e.message||'Could not mark shipped.', true); }
            finally { btn.disabled = false; }
          }));
        }

        async function refreshActive(){
          try {
            if (state.activeTab === 'ai') return await loadAi();
            if (state.activeTab === 'products') return await loadProducts();
            if (state.activeTab === 'orders') return await loadOrders();
            if (state.activeTab === 'revenue') return await loadRevenue();
          } catch (e) { setStatus(e.message||'Refresh failed', true); }
        }

        $$('.tab-btn').forEach((btn)=>btn.addEventListener('click', ()=>{ setTab(btn.getAttribute('data-tab')); }));
        $('#aiRefreshBtn').addEventListener('click', refreshActive);
        $('#productsRefreshBtn').addEventListener('click', refreshActive);
        $('#ordersRefreshBtn').addEventListener('click', refreshActive);
        $('#revenueRefreshBtn').addEventListener('click', refreshActive);
        $('#orderStatus').addEventListener('change', ()=>{ if(state.activeTab==='orders') refreshActive(); });
        $('#orderSearch').addEventListener('keydown', (e)=>{ if(e.key==='Enter') refreshActive(); });
        $('#refreshAllBtn').addEventListener('click', refreshActive);
        $('#newProductBtn').addEventListener('click', ()=>{
          $('#newProductForm').classList.remove('hidden');
        });

        $('#newAddPhotosBtn').addEventListener('click', ()=>{
          $('#newPhotoInput').click();
        });

        $('#newPhotoInput').addEventListener('change', (e)=>{
          setNewPhotoFiles(e.target.files);
          e.target.value = '';
        });

        ['input','change'].forEach((evt)=>{
          $('#productsSearch').addEventListener(evt, ()=>renderProducts(state.products));
          $('#productsStatusFilter').addEventListener(evt, ()=>renderProducts(state.products));
          $('#productsInStockOnly').addEventListener(evt, ()=>renderProducts(state.products));
          $('#productsShowArchived').addEventListener(evt, ()=>renderProducts(state.products));
        });

        $('#cancelProductBtn').addEventListener('click', ()=>{
          $('#newProductForm').classList.add('hidden');
          resetNewProductForm();
        });

        $('#createProductBtn').addEventListener('click', async ()=>{
          const btn = $('#createProductBtn');
          const title = $('#newTitle').value.trim();
          const price = Number($('#newPrice').value || 0);
          const inventory = Number($('#newInventory').value || 1);
          const status = $('#newStatus').value || 'draft';
          const description = $('#newDescription').value || '';

          if (!title) { setStatus('Title is required.', true); return; }
          if (!Number.isFinite(price) || price < 0) { setStatus('Price must be >= 0.', true); return; }
          if (!Number.isInteger(inventory) || inventory < 0) { setStatus('Inventory must be integer >= 0.', true); return; }

          btn.disabled = true;
          try {
            const created = await api('/.netlify/functions/admin-products', {
              method: 'POST',
              body: JSON.stringify({ title, price, inventory, status, description, photos: [] })
            });

            const productId = created && created.product && created.product.id;
            const photos = [];
            if (productId) {
              for (const file of state.newPhotoFiles) {
                const uploadedUrl = await uploadPhotoFile(file, productId);
                photos.push(uploadedUrl);
              }
              if (photos.length) {
                await api('/.netlify/functions/admin-products', {
                  method: 'PATCH',
                  body: JSON.stringify({ id: productId, updates: { photos } })
                });
              }
            }

            await loadProducts();
            $('#newProductForm').classList.add('hidden');
            resetNewProductForm();
            setStatus('Product created.');
          } catch (e) {
            setStatus(e.message || 'Failed to create product.', true);
          } finally {
            btn.disabled = false;
          }
        });

        $('#dbInitBtn').addEventListener('click', async ()=>{
          const btn = $('#dbInitBtn');
          btn.disabled = true;
          try {
            await api('/.netlify/functions/admin-db-init', { method:'POST' });
            await checkDbStatus();
            await Promise.all([loadAi(), loadProducts()]);
            setStatus('Database initialized successfully.');
          } catch (e) {
            setStatus(e.message || 'Database initialization failed.', true);
          } finally {
            btn.disabled = false;
          }
        });

        $('#logoutBtn').addEventListener('click', async ()=>{
          try {
            await api('/.netlify/functions/admin-logout', { method: 'POST' });
            window.location.assign('/admin/login');
          } catch (e) { setStatus(e.message || 'Logout failed', true); }
        });

        checkDbStatus();
        refreshActive();
      })();
    </script>
  </body>
</html>
