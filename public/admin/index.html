<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Sawtooth Thrift Admin</title>
  
    <style>
      .st-save-fab{
        position: fixed;
        right: 16px;
        bottom: 16px;
        z-index: 99999;
        padding: 12px 14px;
        border-radius: 999px;
        border: 1px solid rgba(255,255,255,0.18);
        background: rgba(20,20,20,0.88);
        color: #fff;
        font: 600 14px/1 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        box-shadow: 0 10px 30px rgba(0,0,0,0.35);
        cursor: pointer;
        user-select: none;
      }
      .st-save-fab:hover{ filter: brightness(1.05); }
      .st-save-fab:active{ transform: translateY(1px); }
      .st-save-fab small{
        display:block;
        font-weight: 500;
        opacity: 0.75;
        margin-top: 4px;
      }
    </style>
  
    <script defer src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <script>
      // Optional hardening: require login before showing admin UI.
      // This requires Netlify Identity enabled for the site.
      document.addEventListener("DOMContentLoaded", () => {
        if (!window.netlifyIdentity) return;
        window.netlifyIdentity.on("init", user => {
          if (!user) window.netlifyIdentity.open();
        });
      });
    </script>

  </head>
  <body>
    <!-- Decap CMS -->
    <script>
  (function () {
    // Track save/publish network activity for Decap CMS (Netlify CMS) so we can show a clear "Saved" indicator.
    window.__CMS_SAVE_STATE__ = { status: "idle", message: "", lastOkAt: 0, lastErrAt: 0 };

    function setState(status, message) {
      window.__setCmsSaveState = setState;
      window.__CMS_SAVE_STATE__.status = status;
      window.__CMS_SAVE_STATE__.message = message || "";
      if (status === "saved") window.__CMS_SAVE_STATE__.lastOkAt = Date.now();
      if (status === "error") window.__CMS_SAVE_STATE__.lastErrAt = Date.now();
      window.dispatchEvent(new CustomEvent("st:cmsSaveState", { detail: window.__CMS_SAVE_STATE__ }));
    }

    // Patch fetch
    const origFetch = window.fetch ? window.fetch.bind(window) : null;
    if (origFetch) {
      window.fetch = async function (input, init) {
        try {
          const url = typeof input === "string" ? input : (input && input.url) ? input.url : "";
          const method = (init && init.method) ? String(init.method).toUpperCase() : "GET";

          const isGitWrite = /\/\.netlify\/git\//.test(url) && (method !== "GET");
          if (isGitWrite) setState("saving", "Saving…");

          const res = await origFetch(input, init);

          if (isGitWrite) {
            if (res && res.ok) setState("saved", "Saved");
            else setState("error", "Save failed");
          }
          return res;
        } catch (err) {
          setState("error", "Save failed");
          throw err;
        }
      };
    }

    // Patch XHR (fallback)
    const OrigXHR = window.XMLHttpRequest;
    if (OrigXHR) {
      function PatchedXHR() {
        const xhr = new OrigXHR();
        let _url = "";
        let _method = "GET";
        const origOpen = xhr.open;
        xhr.open = function (method, url) {
          _method = String(method || "GET").toUpperCase();
          _url = String(url || "");
          return origOpen.apply(xhr, arguments);
        };
        xhr.addEventListener("loadstart", function () {
          if (/\/\.netlify\/git\//.test(_url) && _method !== "GET") setState("saving", "Saving…");
        });
        xhr.addEventListener("loadend", function () {
          if (/\/\.netlify\/git\//.test(_url) && _method !== "GET") {
            if (xhr.status >= 200 && xhr.status < 300) setState("saved", "Saved");
            else setState("error", "Save failed");
          }
        });
        xhr.addEventListener("error", function () {
          if (/\/\.netlify\/git\//.test(_url) && _method !== "GET") setState("error", "Save failed");
        });
        return xhr;
      }
      window.XMLHttpRequest = PatchedXHR;
    }

    setState("idle", "");
  })();
</script>

    <script src="https://unpkg.com/decap-cms@^3/dist/decap-cms.js"></script>

    <script>
      (function () {
        window.__CMS_DIRTY__ = false;

        document.addEventListener("input", function (e) {
          const t = e.target;
          if (!t) return;
          const tag = (t.tagName || "").toLowerCase();
          if (tag === "input" || tag === "textarea" || tag === "select") {
            window.__CMS_DIRTY__ = true;
          }
        }, true);

        document.addEventListener("keydown", function (e) {
          const t = e.target;
          if (t && t.isContentEditable) window.__CMS_DIRTY__ = true;
        }, true);

        window.addEventListener("beforeunload", function (e) {
          if (!window.__CMS_DIRTY__) return;
          e.preventDefault();
          e.returnValue = "";
        });

        function findAndClickSave() {
          const candidates = Array.from(document.querySelectorAll("button, [role='button']"));
          const byText = (re) => candidates.find(b => (b.textContent || "").trim().match(re));

          const btn =
            byText(/save\s*draft/i) ||
            byText(/^save$/i) ||
            byText(/save/i) ||
            byText(/publish/i);

          if (btn) {
            btn.click();
            setTimeout(() => { window.__CMS_DIRTY__ = false; }, 800);
            return true;
          }
          return false;
        }

        const fab = document.createElement("button");
        fab.type = "button";
        fab.className = "st-save-fab";
        fab.innerHTML = 'Save <small>(prevents losing edits)</small>';
        fab.addEventListener("click", function () {
          if (window.__setCmsSaveState) window.__setCmsSaveState("saving", "Saving…");
          const ok = findAndClickSave();
          if (!ok) setTimeout(findAndClickSave, 600);

          // If saving is blocked (validation/auth) and no git request fires, surface it.
          setTimeout(() => {
            const st = window.__CMS_SAVE_STATE__ && window.__CMS_SAVE_STATE__.status ? window.__CMS_SAVE_STATE__.status : "idle";
            if (st === "saving" && window.__CMS_DIRTY__) {
              if (window.__setCmsSaveState) window.__setCmsSaveState("error", "Save blocked");
            }
          }, 2500);
        });

        document.addEventListener("DOMContentLoaded", function () {
          document.body.appendChild(fab);
        });
      })();
    </script>

    <script>
  (function () {
    const badge = document.createElement("div");
    badge.id = "st-cms-status";
    badge.style.position = "fixed";
    badge.style.top = "14px";
    badge.style.right = "16px";
    badge.style.zIndex = "100000";
    badge.style.padding = "8px 10px";
    badge.style.borderRadius = "999px";
    badge.style.border = "1px solid rgba(0,0,0,0.10)";
    badge.style.background = "rgba(255,255,255,0.92)";
    badge.style.color = "#111";
    badge.style.font = "700 12px/1 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif";
    badge.style.boxShadow = "0 10px 24px rgba(0,0,0,0.12)";
    badge.style.userSelect = "none";
    badge.style.pointerEvents = "none";
    badge.textContent = "Saved";

    function applyBadge(state) {
      const st = state && state.status ? state.status : "idle";
      if (st === "saving") badge.textContent = "Saving…";
      else if (st === "error") badge.textContent = "Save failed";
      else if (window.__CMS_DIRTY__) badge.textContent = "Unsaved changes";
      else badge.textContent = "Saved";
    }

    function rewriteUnsavedLabel() {
      const nodes = Array.from(document.querySelectorAll("body *"));
      for (const n of nodes) {
        if (!n || !n.childNodes) continue;
        if (n.children && n.children.length) continue;
        const t = (n.textContent || "").trim();
        if (t === "UNSAVED CHANGES" || t === "UNSAVED" || t === "SAVED") {
          n.textContent = window.__CMS_DIRTY__ ? "UNSAVED CHANGES" : "SAVED";
        }
      }
    }

    window.addEventListener("st:cmsSaveState", (e) => {
      applyBadge(e.detail);
      if (e.detail && e.detail.status === "saved") window.__CMS_DIRTY__ = false;
      if (e.detail && e.detail.status === "error") window.__CMS_DIRTY__ = true;
      rewriteUnsavedLabel();
    });

    const mo = new MutationObserver(() => {
      applyBadge(window.__CMS_SAVE_STATE__);
      rewriteUnsavedLabel();
    });

    document.addEventListener("DOMContentLoaded", () => {
      document.body.appendChild(badge);
      mo.observe(document.body, { subtree: true, childList: true, characterData: true });
      applyBadge(window.__CMS_SAVE_STATE__);
      rewriteUnsavedLabel();
    });
  })();
</script>

      <!-- Stripe Tools (Payment Links + Prices) -->
    <style>
      .st-stripe-launcher{
        position: fixed;
        left: 16px;
        bottom: 16px;
        z-index: 99999;
        padding: 12px 14px;
        border-radius: 999px;
        border: 1px solid rgba(255,255,255,0.18);
        background: rgba(11,15,20,0.92);
        color: #fff;
        font: 600 14px/1.1 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        box-shadow: 0 10px 30px rgba(0,0,0,0.35);
        cursor: pointer;
        user-select:none;
      }
      .st-stripe-panel{
        position: fixed;
        left: 16px;
        bottom: 64px;
        width: min(980px, calc(100vw - 32px));
        max-height: min(70vh, 720px);
        z-index: 99999;
        border-radius: 16px;
        border: 1px solid rgba(255,255,255,0.14);
        background: rgba(11,15,20,0.96);
        color: #fff;
        box-shadow: 0 16px 40px rgba(0,0,0,0.45);
        display:none;
        overflow:hidden;
      }
      .st-stripe-panel.open{ display:block; }
      .st-stripe-head{
        display:flex;
        gap:12px;
        align-items:center;
        justify-content:space-between;
        padding: 12px 14px;
        border-bottom: 1px solid rgba(255,255,255,0.12);
      }
      .st-stripe-title{
        display:flex; flex-direction:column; gap:2px;
      }
      .st-stripe-title b{ font-size: 14px; letter-spacing: .2px; }
      .st-stripe-title small{ font-size: 12px; opacity:.7; }
      .st-stripe-actions{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
      .st-stripe-actions a, .st-stripe-actions button{
        color:#fff;
        background: rgba(255,255,255,0.08);
        border: 1px solid rgba(255,255,255,0.14);
        border-radius: 10px;
        padding: 8px 10px;
        font: 600 13px/1 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        cursor:pointer;
        text-decoration:none;
      }
      .st-stripe-actions a:hover, .st-stripe-actions button:hover{ filter: brightness(1.08); }
      .st-stripe-actions input{
        width: 260px;
        max-width: calc(100vw - 220px);
        padding: 8px 10px;
        border-radius: 10px;
        border: 1px solid rgba(255,255,255,0.14);
        background: rgba(0,0,0,0.25);
        color:#fff;
        outline:none;
      }
      .st-stripe-body{
        padding: 10px 14px 14px;
        overflow:auto;
        max-height: calc(min(70vh, 720px) - 58px);
      }
      .st-stripe-row{
        display:grid;
        grid-template-columns: 1.4fr .6fr .8fr .9fr;
        gap: 10px;
        align-items:center;
        padding: 10px 10px;
        border: 1px solid rgba(255,255,255,0.10);
        border-radius: 12px;
        margin-bottom: 10px;
        background: rgba(255,255,255,0.03);
      }
      .st-stripe-row b{ display:block; font-size: 13px; }
      .st-stripe-row small{ display:block; font-size: 12px; opacity:.75; margin-top: 3px; word-break: break-word; }
      .st-pill{
        display:inline-flex; align-items:center;
        padding: 3px 8px;
        border-radius: 999px;
        border: 1px solid rgba(255,255,255,0.14);
        background: rgba(255,255,255,0.06);
        font-size: 12px;
        opacity: .9;
        justify-self:start;
        width: fit-content;
      }
      .st-mini-btn{
        justify-self:end;
        display:flex;
        gap:8px;
        flex-wrap:wrap;
        justify-content:flex-end;
      }
      .st-mini-btn button{
        padding: 8px 10px;
        border-radius: 10px;
        border: 1px solid rgba(255,255,255,0.14);
        background: rgba(255,255,255,0.08);
        color:#fff;
        font: 600 12px/1 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        cursor:pointer;
      }
      .st-mini-btn button:active{ transform: translateY(1px); }
      .st-stripe-note{
        margin: 8px 0 12px;
        font-size: 12px;
        opacity:.75;
      }
      .st-muted{ opacity:.7; }
      @media (max-width: 720px){
        .st-stripe-row{ grid-template-columns: 1fr; }
        .st-mini-btn{ justify-self:start; }
        .st-stripe-actions input{ width: 180px; }
      }
    </style>

    <button class="st-stripe-launcher" id="stStripeLauncher" type="button">Stripe Tools</button>

    <div class="st-stripe-panel" id="stStripePanel" role="dialog" aria-label="Stripe Tools">
      <div class="st-stripe-head">
        <div class="st-stripe-title">
          <b>Stripe Payment Links</b>
          <small>Pull product prices + payment links and copy/apply into the editor.</small>
        </div>
        <div class="st-stripe-actions">
          <a href="https://dashboard.stripe.com/acct_1SgZPbBON6LiE0Or/dashboard" target="_blank" rel="noopener">Open Stripe Dashboard</a>
          <button type="button" id="stStripeRefresh">Refresh</button>
          <input id="stStripeSearch" type="text" placeholder="Search product…" />
          <button type="button" id="stStripeClose">Close</button>
        </div>
      </div>
      <div class="st-stripe-body">
        <div class="st-stripe-note">
          Tip: open a product in Decap CMS, then use “Apply” to set <span class="st-muted">Price</span> and <span class="st-muted">Stripe Payment Link</span>.
        </div>
        <div id="stStripeStatus" class="st-stripe-note"></div>
        <div id="stStripeList"></div>
      </div>
    </div>

    <script>
      (function(){
        const $ = (sel) => document.querySelector(sel);
        const launcher = $("#stStripeLauncher");
        const panel = $("#stStripePanel");
        const btnClose = $("#stStripeClose");
        const btnRefresh = $("#stStripeRefresh");
        const search = $("#stStripeSearch");
        const listEl = $("#stStripeList");
        const statusEl = $("#stStripeStatus");

        let cache = [];

        function setStatus(msg){
          if (!statusEl) return;
          statusEl.textContent = msg || "";
        }

        function money(unitAmount, currency){
          if (typeof unitAmount !== "number") return "";
          const amt = unitAmount / 100;
          const cur = (currency || "usd").toUpperCase();
          // Keep it simple to avoid locale surprises in admin UI
          return `${cur} ${amt.toFixed(2)}`;
        }

        async function copyToClipboard(text){
          try{
            await navigator.clipboard.writeText(text);
            setStatus("Copied to clipboard.");
            setTimeout(()=>setStatus(""), 1200);
          }catch(e){
            // Fallback
            const ta = document.createElement("textarea");
            ta.value = text;
            ta.style.position = "fixed";
            ta.style.opacity = "0";
            document.body.appendChild(ta);
            ta.select();
            document.execCommand("copy");
            document.body.removeChild(ta);
            setStatus("Copied to clipboard.");
            setTimeout(()=>setStatus(""), 1200);
          }
        }

        function findInputByLabelText(labelText){
          const labels = Array.from(document.querySelectorAll("label"));
          const label = labels.find(l => (l.textContent || "").trim().toLowerCase() === labelText.toLowerCase());
          if (label){
            const forId = label.getAttribute("for");
            if (forId) return document.getElementById(forId);
            const input = label.querySelector("input, textarea");
            if (input) return input;
          }
          return null;
        }

        function findCmsField(labelCandidates){
          for (const label of labelCandidates){
            const el = findInputByLabelText(label);
            if (el) return el;
          }
          // fallback: search common input types by aria-label
          const all = Array.from(document.querySelectorAll("input, textarea"));
          for (const cand of labelCandidates){
            const lc = cand.toLowerCase();
            const el = all.find(x => ((x.getAttribute("aria-label")||"").toLowerCase() === lc));
            if (el) return el;
          }
          return null;
        }

        function setFieldValue(el, value){
          if (!el) return false;
          el.focus();
          el.value = value;
          el.dispatchEvent(new Event("input", { bubbles: true }));
          el.dispatchEvent(new Event("change", { bubbles: true }));
          return true;
        }

        function applyToEditor(item){
          const priceValue = (typeof item.unit_amount === "number") ? (item.unit_amount / 100).toFixed(2) : "";
          const linkValue = item.payment_link_url || "";

          const priceEl = findCmsField(["Price"]);
          const linkEl = findCmsField(["Stripe Payment Link", "Stripe payment link", "Stripe Payment link"]);

          const ok1 = setFieldValue(priceEl, priceValue);
          const ok2 = setFieldValue(linkEl, linkValue);

          if (ok1 || ok2){
            setStatus("Applied to editor fields.");
            setTimeout(()=>setStatus(""), 1500);
          } else {
            setStatus("Could not find editor fields. Use Copy buttons instead.");
          }
        }


        function buildShippingLabel(item, recipient) {
          const fromName = "Sawtooth Thrift";
          const fromLine1 = "Twin Falls, ID";
          const toBlock = [
            recipient.name,
            recipient.line1,
            recipient.line2,
            `${recipient.city}, ${recipient.state} ${recipient.zip}`,
            recipient.country || "US",
          ].filter(Boolean).join("\n");

          const itemLine = `${item.product_name || item.product_id || "Item"} (${money(item.unit_amount, item.currency)})`;
          const orderRef = item.payment_link_id || item.price_id || "n/a";

          return [
            "FROM:",
            fromName,
            fromLine1,
            "",
            "TO:",
            toBlock,
            "",
            "ITEM:",
            itemLine,
            `Ref: ${orderRef}`,
            "",
            "Carrier: USPS / UPS",
            "Service: Ground",
            "Tracking #: ____________________",
          ].join("\n");
        }

        async function openShippingLabel(item){
          const recipient = {
            name: prompt("Recipient full name:"),
            line1: prompt("Address line 1:"),
            line2: prompt("Address line 2 (optional):") || "",
            city: prompt("City:"),
            state: prompt("State (e.g. ID):"),
            zip: prompt("ZIP code:"),
            country: prompt("Country code", "US") || "US",
          };

          if (!recipient.name || !recipient.line1 || !recipient.city || !recipient.state || !recipient.zip) {
            setStatus("Shipping label canceled (missing required address fields).");
            return;
          }

          const label = buildShippingLabel(item, recipient);
          copyToClipboard(label);

          const w = window.open("", "_blank", "noopener,noreferrer,width=420,height=620");
          if (w && w.document) {
            w.document.write(`<pre style="font:14px/1.45 ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; padding:16px; white-space:pre-wrap;">${escapeHtml(label)}</pre>`);
            w.document.close();
          }

          setStatus("Shipping label generated and copied.");
          setTimeout(()=>setStatus(""), 1800);
        }

        function rowTemplate(item){
          const title = item.product_name || item.product_id || "Stripe item";
          const priceStr = money(item.unit_amount, item.currency);
          const priceId = item.price_id ? `Price: ${item.price_id}` : "";
          const plId = item.payment_link_id ? `Link: ${item.payment_link_id}` : "";
          const active = item.payment_link_active ? "Active" : "Inactive";
          const url = item.payment_link_url || "";

          const div = document.createElement("div");
          div.className = "st-stripe-row";
          div.innerHTML = `
            <div>
              <b>${escapeHtml(title)}</b>
              <small>${escapeHtml(priceStr)} <span class="st-muted">•</span> <span class="st-muted">${escapeHtml(active)}</span></small>
              <small class="st-muted">${escapeHtml(priceId)} ${plId ? "• " + escapeHtml(plId) : ""}</small>
              <small><a href="${escapeAttr(url)}" target="_blank" rel="noopener" style="color:#fff; opacity:.9;">${escapeHtml(url)}</a></small>
            </div>
            <div class="st-pill">${escapeHtml((item.currency||"usd").toUpperCase())}</div>
            <div class="st-pill">${item.recurring ? "Recurring" : "One-time"}</div>
            <div class="st-mini-btn">
              <button type="button" data-action="copy-price">Copy Price</button>
              <button type="button" data-action="copy-link">Copy Link</button>
              <button type="button" data-action="apply">Apply</button>
              <button type="button" data-action="label">Shipping Label</button>
            </div>
          `;

          div.querySelector('[data-action="copy-price"]').addEventListener("click", () => {
            const priceValue = (typeof item.unit_amount === "number") ? (item.unit_amount / 100).toFixed(2) : "";
            copyToClipboard(priceValue);
          });
          div.querySelector('[data-action="copy-link"]').addEventListener("click", () => copyToClipboard(url));
          div.querySelector('[data-action="apply"]').addEventListener("click", () => applyToEditor(item));
          div.querySelector('[data-action="label"]').addEventListener("click", () => openShippingLabel(item));

          return div;
        }

        function escapeHtml(s){
          return String(s || "").replace(/[&<>"']/g, (c) => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
        }
        function escapeAttr(s){
          return escapeHtml(s).replace(/"/g, "&quot;");
        }

        function render(){
          const q = (search && search.value ? search.value.trim().toLowerCase() : "");
          const items = !q ? cache : cache.filter(x => (x.product_name||"").toLowerCase().includes(q) || (x.product_id||"").toLowerCase().includes(q));
          listEl.innerHTML = "";
          if (!items.length){
            const empty = document.createElement("div");
            empty.className = "st-stripe-note";
            empty.textContent = q ? "No matches." : "No items loaded yet.";
            listEl.appendChild(empty);
            return;
          }
          for (const item of items){
            listEl.appendChild(rowTemplate(item));
          }
        }

        async function getJwt(){
          if (!window.netlifyIdentity) return null;
          const user = window.netlifyIdentity.currentUser();
          if (!user) return null;
          try{
            return await user.jwt();
          }catch(e){
            return null;
          }
        }

        async function refresh(){
          setStatus("Loading from Stripe…");
          cache = [];
          render();

          const jwt = await getJwt();
          if (!jwt){
            setStatus("Please log in to Netlify Identity first.");
            return;
          }

          try{
            const res = await fetch("/.netlify/functions/stripe-payment-links", {
              headers: { "Authorization": "Bearer " + jwt }
            });
            const data = await res.json().catch(()=> ({}));
            if (!res.ok || !data.ok){
              setStatus((data && data.error) ? data.error : ("Request failed ("+res.status+")"));
              return;
            }
            cache = Array.isArray(data.items) ? data.items : [];
            setStatus("Loaded " + cache.length + " items.");
            setTimeout(()=>setStatus(""), 1500);
            render();
          }catch(e){
            setStatus("Error loading Stripe data.");
          }
        }

        function toggle(open){
          if (open){
            panel.classList.add("open");
            launcher.style.display = "none";
            // auto-load on first open if empty
            if (!cache.length) refresh();
          } else {
            panel.classList.remove("open");
            launcher.style.display = "";
          }
        }

        launcher.addEventListener("click", () => toggle(true));
        btnClose.addEventListener("click", () => toggle(false));
        btnRefresh.addEventListener("click", refresh);
        search.addEventListener("input", render);

        // Close panel on Escape
        document.addEventListener("keydown", (e) => {
          if (e.key === "Escape" && panel.classList.contains("open")) toggle(false);
        });
      })();
    </script>

    <style>
      .st-admin-quickbar{
        position: fixed;
        right: 16px;
        bottom: 82px;
        z-index: 99998;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .st-admin-quickbar a, .st-admin-quickbar button{
        border: 1px solid rgba(255,255,255,0.18);
        background: rgba(11,15,20,0.92);
        color: #fff;
        border-radius: 10px;
        padding: 9px 12px;
        font: 600 13px/1 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        text-decoration: none;
      }
      @media (max-width: 640px){
        .st-admin-quickbar{ right: 12px; bottom: 74px; }
        .st-admin-quickbar a, .st-admin-quickbar button{ padding: 12px 14px; font-size: 14px; }
      }
    </style>
    <script>
      (function(){
        const bar = document.createElement("div");
        bar.className = "st-admin-quickbar";

        const live = document.createElement("a");
        live.href = "/";
        live.target = "_blank";
        live.rel = "noopener";
        live.textContent = "Open storefront";

        const add = document.createElement("button");
        add.type = "button";
        add.textContent = "New product";
        add.addEventListener("click", () => {
          const buttons = Array.from(document.querySelectorAll("button, [role='button']"));
          const create = buttons.find((b) => /new|create/i.test((b.textContent || "").trim()));
          if (create) create.click();
        });

        const search = document.createElement("button");
        search.type = "button";
        search.textContent = "Focus search";
        search.addEventListener("click", () => {
          const input = document.querySelector("input[type='search'], input[placeholder*='Search'], input[aria-label*='Search']");
          if (input) input.focus();
        });

        bar.append(live, add, search);
        document.addEventListener("DOMContentLoaded", () => document.body.appendChild(bar));
      })();
    </script>



    <style>
      .st-ai-launcher{
        position: fixed;
        left: 16px;
        bottom: 64px;
        z-index: 99998;
        padding: 12px 14px;
        border-radius: 999px;
        border: 1px solid rgba(255,255,255,0.18);
        background: rgba(28,18,52,0.95);
        color: #fff;
        font: 700 14px/1 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        box-shadow: 0 10px 30px rgba(0,0,0,0.35);
        cursor: pointer;
      }
      .st-ai-panel{
        position: fixed;
        left: 16px;
        top: 16px;
        width: min(560px, calc(100vw - 32px));
        max-height: calc(100vh - 32px);
        z-index: 100000;
        display: none;
        border: 1px solid rgba(255,255,255,0.14);
        border-radius: 14px;
        background: rgba(11,15,20,0.98);
        color: #fff;
        overflow: hidden;
      }
      .st-ai-panel.open{ display: block; }
      .st-ai-head{ display:flex; justify-content:space-between; align-items:center; gap:8px; padding:12px; border-bottom:1px solid rgba(255,255,255,0.12); }
      .st-ai-body{ display:grid; gap:10px; padding:12px; }
      .st-ai-q{ width:100%; min-height:84px; border-radius:10px; border:1px solid rgba(255,255,255,0.16); background: rgba(255,255,255,0.06); color:#fff; padding:10px; }
      .st-ai-actions{ display:flex; gap:8px; flex-wrap:wrap; }
      .st-ai-actions button{ border:1px solid rgba(255,255,255,0.15); background:rgba(255,255,255,0.08); color:#fff; border-radius:10px; padding:8px 10px; cursor:pointer; }
      .st-ai-out{ white-space:pre-wrap; font: 500 13px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; border:1px solid rgba(255,255,255,0.12); border-radius:10px; padding:10px; min-height:110px; max-height:50vh; overflow:auto; }
      .st-ai-loading{ display:none; align-items:center; gap:8px; font-size:12px; opacity:0.85; }
      .st-ai-loading.show{ display:flex; }
      .st-ai-dots i{ display:inline-block; width:6px; height:6px; border-radius:50%; background:#fff; margin-right:4px; opacity:.4; animation: stDot 1s infinite; }
      .st-ai-dots i:nth-child(2){ animation-delay:.2s; }
      .st-ai-dots i:nth-child(3){ animation-delay:.4s; }
      @keyframes stDot { 0%,80%,100%{opacity:.25; transform: translateY(0);} 40%{opacity:1; transform: translateY(-2px);} }
    </style>

    <button class="st-ai-launcher" id="stAiLauncher" type="button">AI Insights</button>
    <div class="st-ai-panel" id="stAiPanel" role="dialog" aria-label="AI Insights">
      <div class="st-ai-head">
        <div><b>AI Insights</b><br/><small style="opacity:.75;">Twin Falls sourcing + Stripe revenue tips</small></div>
        <button type="button" id="stAiClose" style="border:1px solid rgba(255,255,255,0.18); background:rgba(255,255,255,0.08); color:#fff; border-radius:10px; padding:6px 10px;">Close</button>
      </div>
      <div class="st-ai-body">
        <textarea id="stAiQuestion" class="st-ai-q" placeholder="Ask: What should I buy this week in Twin Falls for quick resale?">What should I buy this week in Twin Falls for quick resale and how should I price it?</textarea>
        <div class="st-ai-actions">
          <button type="button" id="stAiAsk">Ask AI</button>
          <button type="button" id="stAiCopy">Copy</button>
        </div>
        <div class="st-ai-loading" id="stAiLoading"><span class="st-ai-dots"><i></i><i></i><i></i></span> Thinking…</div>
        <div class="st-ai-out" id="stAiOutput">Ask a question to get simple buying + revenue insights.</div>
      </div>
    </div>

    <script>
      (function(){
        const launcher = document.getElementById("stAiLauncher");
        const panel = document.getElementById("stAiPanel");
        const close = document.getElementById("stAiClose");
        const askBtn = document.getElementById("stAiAsk");
        const copyBtn = document.getElementById("stAiCopy");
        const qEl = document.getElementById("stAiQuestion");
        const out = document.getElementById("stAiOutput");
        const loading = document.getElementById("stAiLoading");

        async function getJwt(){
          if (!window.netlifyIdentity) return null;
          const user = window.netlifyIdentity.currentUser();
          if (!user) return null;
          try { return await user.jwt(); } catch (e) { return null; }
        }

        function setLoading(on){
          loading.classList.toggle("show", !!on);
          askBtn.disabled = !!on;
        }

        async function askAI(){
          const question = (qEl.value || "").trim();
          if (!question) return;

          const jwt = await getJwt();
          if (!jwt){
            out.textContent = "Please log in to admin first.";
            return;
          }

          setLoading(true);
          out.textContent = "";
          try{
            const res = await fetch("/.netlify/functions/ai-insights", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "Authorization": "Bearer " + jwt,
              },
              body: JSON.stringify({ question }),
            });
            const data = await res.json().catch(() => ({}));
            if (!res.ok || !data.ok){
              out.textContent = (data && data.error) ? data.error : ("Request failed (" + res.status + ")");
              return;
            }
            out.textContent = data.answer || "No answer returned.";
          } catch (e) {
            out.textContent = "Could not load AI insights right now.";
          } finally {
            setLoading(false);
          }
        }

        launcher.addEventListener("click", () => panel.classList.add("open"));
        close.addEventListener("click", () => panel.classList.remove("open"));
        askBtn.addEventListener("click", askAI);
        copyBtn.addEventListener("click", async () => {
          const text = out.textContent || "";
          if (!text.trim()) return;
          try { await navigator.clipboard.writeText(text); } catch (e) {}
        });
      })();
    </script>

</body>
</html>
 
